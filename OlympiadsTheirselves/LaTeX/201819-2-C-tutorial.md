Справді обчислювати сам факторіал і шукати його останню ненульову
цифру--- формально правильно, але набирає дуже мало балів. Факторіал
дуже швидко зростає: $8!\dib{{=}}40\,320$ вже непоміщається у16-бітовий
знаковий цілий тип, $13!\dib{{=}}6\,227\,020\,800$--- у32-бітовий,
$21!\dib{{=}}51\,090\,942\,171\,709\,440\,000$--- у64-бітовий. Так що
для мов програмування, в яких найбільшим цілочисельним типом є
64-бітовий, цей підхід правильний лише для ${N\,{\<}\,20}$.

Межу ${N\,{\<}\,20}$ можна збільшити до ${N\,{\<}\,23}$, якщо щоразу,
коли додається нуль наприкінці, тут же відкидати його : $1
\dib{{\xrightarrow{\*2}}}2
\dib{{\xrightarrow{\*3}}}6
\dib{{\xrightarrow{\*4}}}24
\dib{{\xrightarrow[/10]{\*5}}}12
\dib{{\xrightarrow{\*6}}}72
\dib{{\xrightarrow{\*7}}}504
\dib{{\xrightarrow{\*8}}}4032
\dib{{\xrightarrow{\*9}}}36288
\dib{{\xrightarrow[/10]{\*10}}}36288
\dib{{\xrightarrow{\*11}}}\dots$

Деякі з дозволених на олімпіаді мов програмування мають вбудовану довгу
арифметику, тобто вміють працювати зі значно більшими цілими числами:
Python--- просто; Java--- через бібліотечний тип `BigInteger`. (C# теж
має тип `BigInteger`, але там усе сумніше, бо засоби, якими `BigInteger`
підключається на локальному Windows-комп'ютері, не працюють на
Linux-сервері ejudge, і авторам збірника невідомо ні як їх підключити
там, ні, навіть, чи можливо це взагалі.) Використання довгої арифметики
(байдуже, готової чи написаної власноруч) дозволяє дещо розширити
діапазон $N$, але недостатньо: з нею повинні проходити не лише всі тести
з $N\,{\<}\,23$, а й усі блоки тестів з $N\,{\<}\,555$. А подальші блоки
повинні не проходити: наприклад, 50000! має понад 200 тис. десяткових
цифр, так що обчислення не мають шансів поміститися в обмеження за
часом.

Раз питають *лише останню* ненульову цифру, *нема потреби* обчислювати
та зберігати *всі* цифри факторіалів. Але це й *не* класична
\<\<модульна арифметика\>\> (в якій досить зберігати лише останню
цифру), бо питають *останню ненульову*, кількість нулів наприкінці $N!$
зі зростанням $N$ час від часу збільшується, й потрібний розряд час від
часу зсувається: при $1\dib{{\<}}N\dib{{\<}}4$ це розряд одиниць
(остання цифра), при $5\dib{{\<}}N\dib{{\<}}9$--- розряд десятків
(передостання цифра), тощо.

Спробуємо з'ясувати, коли скільки нулів додається наприкінці факторіалу.
Важливо, що розглядаємо са́ме десяткову систему числення
($10\dibbb{{=}}2^1\cdot5^1$) і са́ме
$N! \dibbb{{=}} 1\dib{{\times}}2\dib{{\times}}\dots\dib{{\times}}N$.
Якебнебуло число вигляду${5^{a}\times{}b}$, число ${2^{a}\times{}b}$
(притихсамих додатних$a$, $b$) існує і менше${5^{a}\times{}b}$. Так що,
при послідовному домноженні
$(1\dib{{\times}}2\dib{{\times}}\dots\dib{{\times}}(N{-}1))\dib{{\times}}N$,
на кожну п'ятірку, скількибїхнебуло в розкладенні $N$, \<\<вже чека́є\>\>
відповідна кількість двійок, наявних у розкладенні$(N{-}1)!$ і
щеневикористаних іншими п'ятірками. Такщо кожне число, яке можна подати
як ${5^{a}\times{}b}$ (де$b$не кратне 5) додає наприкінці факторіала
рівно $a$нулів.

Оскільки
$5^9\dib{{=}}1\,953\,125\dib{{<}}2\,018\,019\dib{{<}}9\,765\,625\dib{{=}}5^{10}$,
за одне домноження з'являтиметься щонайбільше дев'ять нулів. І ніщо
не заважає поєднати такі ідеї: (1) відкидати нулі наприкінці, яктільки
вони з'являються; (2) зберігати (у 64-бітовій змінній) останні
10--12десяткових цифр. Якось так: $1
\dibbb{{\xrightarrow{\*2}}}2
\dibbb{{\xrightarrow{\*3}}}6
\dibbb{{\xrightarrow{\*4}}}24
\dibbb{{\xrightarrow[/10]{\*5}}}12
\dibbb{{\xrightarrow{\*6}}}72
\dibbb{{\xrightarrow{\*7}}}504
\dibbb{{\xrightarrow{\*8}}}4032
\dibbb{{\xrightarrow{\*9}}}36288
\dibbb{{\xrightarrow[/10]{\*10}}}36288
\dibbb{{\xrightarrow{\*11}}}399168  
\dibbb{{\xrightarrow{\*12}}}4790016 
\dibbb{{\xrightarrow{\*13}}}62270208    
\dibbb{{\xrightarrow{\*14}}}871782912   
\dibbb{{\xrightarrow[/10]{\*15}}}1307674368 
\dibbb{{\xrightarrow[\bmod10^{10}]{\*16}}}922789888 
\dibbb{{\xrightarrow[\bmod10^{10}]{\*17}}}5687428096    
\dibbb{{\xrightarrow[\bmod10^{10}]{\*18}}}2373705728    
\dibbb{{\xrightarrow[\bmod10^{10}]{\*19}}}5100408832    
\dibbb{{\xrightarrow[/10,\quad\bmod10^{10}]{\*20}}}200817664    
\dibbb{{\xrightarrow{\*21}}}4217170944  
\dibbb{{\xrightarrow[\bmod10^{10}]{\*22}}}2777760768    
\dibbb{{\xrightarrow[\bmod10^{10}]{\*23}}}3888497664    
\dibbb{{\xrightarrow[\bmod10^{10}]{\*24}}}3323943936    
\dibbb{{\xrightarrow[/100]{\*25}}}830985984 
\dibbb{{\xrightarrow[\bmod10^{10}]{\*26}}}1605635584    
\dibbb{{\xrightarrow[\bmod10^{10}]{\*27}}}\dots$Для${N\,{<}\,5^{10}}$,
10--12 цифр водночас ідосить багато, щоб не втратити зразу всі ненульові
цифри, ідосить мало, щоб при черговому домноженні ніколи не виникало
переповнення 64-бітового типу.

Вже відзначено, що класична модульна арифметика (зберігати лише останню
цифру) незастосовна, бо питають останню *ненульову*, й потрібний розряд
час від часу зсувається. Але можна помітити, що раз кількість нулів
наприкінці визначається кількістю п'ятірок, то, прибравши з$N!$
відповідну кількість п'ятірок і таку саму кількість двійок, отримаємо
якраз факторіал крім нулів наприкінці; для цього факторіала крім нулів
наприкінці *можна* зберігати й обчислювати саму́ лише останню цифру.

Конкретніше, будемо при обчисленні
$1\dib{{\times}}2\dib{{\times}}\dots\dib{{\times}}i\dib{{\times}}\dots$
\<\<виймати\>\> з кожного числа́ всі множникита 5, і рахувати окремо
останню цифру добутку *всього, крім* \<\<вийнятих\>\> двійок та
п'ятірок, окремо різницю кількостей \<\<вийнятих\>\> (на скільки двійок
більше, ніж п'ятірок). Якось так:

::: longtable
\@c\|c\|l\|p0.65\|c\|c@ & Множимо на & &\
& 0 &  $2=2^1\cdot5^0\cdot1$ &

::: small
двійок стає на одну більше
:::

& 1 & 1\
& 1 &  $3=2^0\cdot5^0\cdot3$ &

::: small
кількості двійок та п'ятірок незмінні, добуток решти домножується на 3
:::

& 3 & 1\
& 1 &  $4=2^2\cdot5^0\cdot1$ &

::: small
двійок стає на дві більше
:::

& 3 & 3\
& 3 &  $5=2^0\cdot5^1\cdot1$ &

::: small
\<\<зайвих\>\> двійок стає на одну менше, бо одна двійка
\<\<зв'язується\>\> п'ятіркою
:::

& 3 & 2\
& 2 &  $6=2^1\cdot5^0\cdot3$ &

::: small
і двійок стає на одну більше, і добуток решти домножується на 3
:::

& 9 & 3\
& 3 &  $7=2^1\cdot5^0\cdot7$ &

::: small
кількості двійок та п'ятірок незмінні, добуток решти домножується на 7,
зберігаємо з 63 лише останню цифру 3
:::

& 3 & 3\
& 3 &  $8=2^3\cdot5^0\cdot1$ &

::: small
двійок стає на три більше
:::

& 3 & 6\
& 6 &  $9=2^0\cdot5^0\cdot9$ & & 7 & 6\
& 6 & $10=2^1\cdot5^1\cdot1$ &

::: small
додаються одна двійка й одна п'ятірка, *різниця* кількостей незмінна
:::

& 7 & 6\
& 6 & $11=2^0\cdot5^0\cdot11$ & & 7 & 6\
& 6 & $12=2^2\cdot5^0\cdot3$ & & 1 & 8\
& 8 & $13=2^0\cdot5^0\cdot13$ & & 3 & 8\
& 8 & $14=2^1\cdot5^0\cdot7$ & & 1 & 9\
& 9 & $15=2^0\cdot5^1\cdot3$ &

::: small
\<\<зайвих\>\> двійок стає на одну менше, бо одна двійка
\<\<зв'язується\>\> п'ятіркою; крім того, добуток решти домножується
на 3
:::

& 3 & 8
:::

І так далі. Дорахувавши до множника $N$ (включно), знаємо останню цифру
\<\<$N!$ бездвійок та п'ятірок\>\> (позначимо як $d$) та кількість
\<\<вільних\>\> (не \<\<зв'язаних\>\> п'ятірками) двійок (позначимо
як $k$). Остато́чна відповідь може бути виражена як $(d\cdot2^k)\bmod10
\dib{{=}}
\bigl(d\cdot(2^k\bmod10)\bigr)\bmod10$. Враховуючи, що ${2^0\,{=}\,1}$,
${2^1\,{=}\,2}$, ${2^2\,{=}\,4}$, ${2^3\,{=}\,8}$,
\[1ex\]\[0pt\]${2^4\,{=}\,1\underline{\underline{6}}}$,
\[1ex\]\[0pt\]${2^5\,{=}\,3\underline{\underline{2}}}$,
\[1ex\]\[0pt\]${2^6\,{=}\,6\underline{\underline{4}}}$,
\[1ex\]\[0pt\]${2^7\,{=}\,12\underline{\underline{8}}}$,
\[1ex\]\[0pt\]${2^8\,{=}\,25\underline{\underline{6}}}$, ..., тобто при
${k\,{>}\,0}$ останні цифри циклічно повторюються, велике $k$ можна
замінити на${(k\bmod4)}\dib{{+}}4$, щодає можливість обчислювати
$2^k\bmod10$ за $\Theta(1)$. Втім, це мало на що впливає, бо основний
процес домножень (із \<\<вийманням\>\> з кожного числа́ двійок та
п'ятірок) значно довший.

Важко сказати. Вони обидва мають складність $\Theta(N)$. (Може здатися,
ніби для дру́гого є ще внутрішні цикли \<\<викидання\>\> двійок і
п'ятірок, які дають додатковий множник $\log{}N$; але цене так.
Наприклад, сумарну кількість ітерацій, які шукають двійки, можна
виразити як ${N\mathbin{\mathrm{div}}2}\dibbb{{+}}
{N\mathbin{\mathrm{div}}2^2}\dib{{+}}
\dots\dibbb{{+}}
{N\mathbin{\mathrm{div}}2^k}$, де ${k\,{=}\,\lfloor\log_2{N}\rfloor}$;
див.аргументацію
формули ([\[eq:201213-2-C-binary\]](#eq:201213-2-C-binary){reference-type="ref"
reference="eq:201213-2-C-binary"}) настор. . Формула суми геометричної
прогресії каже, що ця сума менша $N$.) При вказаних обмеженнях, обидва
ці способи гарантовано проходять усі тести (всіма доступними на
олімпіаді мовами програмування, *крім Python*; див.наступний абзац).
Теоретичний недолік першого способу--- якби дозволялися значення
$N\dib{{\>}}5^{11}\dib{{\approx}}{}$`<!-- -->`{=html}48,8 млн, то
64-бітового типу вже було б недостатньо, щоб задовольнити обидві вимоги
\<\<не втратити зразу всі ненульові цифри\>\> та \<\<не утворювати
переповнень\>\>; дру́гому ж способу цілком достатньо як 64-бітового, так
і навіть 32-бітового типу аж до
$N\dib{{\approx}}\frac{2^{31}}{9}\dib{{\approx}}$`<!-- -->`{=html}238 млн
(але при ${N\,{\approx}\,10^8}$ обчислення вже тривали б десятки
секунд).

Він сам себе скривдив. Програмам усіма мовами програмування виділявся
однаковий ліміт часу. Але для розрахунків, вжитих в обох цих способах,
Python виявився значно повільнішим не лише за традиційно швидкі мови
`g++` та`fpc`, атакож і за відносно повільні `java`, `pasabc-``linux`
та`mcs`. Враховуючи цю об'єктивну і значну різницю швидкодії, перед
туром було прийняте свідоме рішення змиритися з тим, що реалізації
одного алгоритму різними мовами набирають різні бали. З точки зору
правил та традицій Всеукраїнської олімпіади з інформатики, це погано,
але в такого роду виключних випадках допускається. До того ж, у цій
самій задачі Python дозволяв отримати бали за тести вигляду
$25\,{\<}\,N\,{\<}\,555$, пишучи \<\<лобовий\>\> розв'язок і взагалі
не замислюючись над тим, що така програма використовує довгу арифметику.
Учасники, що вміють писати лише на Pascal чи C++, такої можливості
не мали, і їм це ніяк не компенсувалося. ТожPython виграє́ водному,
програє́ віншому, й наврядчи було б справедливішим надавати йому
додаткові переваги, збільшуючи ліміт часу. Тимпа́че, що існує ще
наступний спосіб.

Обмеження ${N\,{\<}\,2\,018\,019}$ підбиралося під те, щоб переважною
більшістю мов працювали й набирали повний бал способи 1--2. Але задачу
*можна* розв'язати ще значно ефективніше, якщо правильно модифікувати
початий у способі $\,$`<!-- -->`{=html}2 підхід \<\<двійки компенсують
п'ятірки, для решти рахуємо останню цифру\>\>. Вважаємо гарантованим
${N\,{\>}\,10}$, бо для ${N\,{<}\,10}$ можна написати окремий`if`, щоб
рахувати \<\<в лоб\>\>. Виділимо окремо множники, кратні 5, окремо
решту, причому решту розіб'ємо на групи згідно десятків. Наприклад, для
37! буде так:
${(1{\times}2{\times}3{\times}4{\times}6{\times}7{\times}8{\times}9)}\dibbb{{\times}}(5{\times}10)\dibbb{{\times}}
{(11{\times}12{\times}13{\times}14{\times}16{\times}17{\times}18{\times}19)}\dibbb{{\times}}(15{\times}20)\dibbb{{\times}}
{(21{\times}22{\times}23{\times}24{\times}26{\times}27{\times}28{\times}29)}\dibbb{{\times}}(25{\times}30)\dibbb{{\times}}
{(31{\times}32{\times}33{\times}34{\times}36{\times}37)}\dibbb{{\times}}(35)$.
Добуток $(5{\times}10)\dibbb{{\times}}
(15{\times}20)\dibbb{{\times}}
(25{\times}30)\dibbb{{\times}}
(35)$ можна подати як $((5{\cdot}1)\,{\times}\,
(5{\cdot}2))\dib{{\times}}
((5{\cdot}3)\,{\times}\,
(5{\cdot}4))\dib{{\times}}
((5{\cdot}5)\,{\times}\,
(5{\cdot}6))\dib{{\times}}
(5{\cdot}7)
\dibbb{{=}}
{5^7\,{\times}\,{7!}}$. (Важливо, що з кожного числа́, кратного 5,
виділяється рівно одна п'ятірка, навіть якщо, як з 25, їх можна було б
виділити більше.) Так можна робити й при інших $N$, отримуючи
$5^{N\mathbin{\mathrm{div}}5}\dib{{\times}}{(N\mathbin{\mathrm{div}}5)!}$.
Тобто, з початкової задачі для $N!$ можна виділити таку саму задачу для
${(N\mathbin{\mathrm{div}}5)!}$, іприцьому решта множників поділені на
більш-менш зручні групи по 8 з кожного десятку (в останній групі, йлише
уній, може бути менше). Тож будемо окремо заново розв'язувати всю задачу
для ${(N\mathbin{\mathrm{div}}5)!}$, і окремо компенсувати п'ятірки,
зібранів $5^{N\mathbin{\mathrm{div}}5}$, двійками з решти добутків.

Тобто, ${(N\mathbin{\mathrm{div}}5)}$ двійок треба \<\<вийняти\>\> з тих
решти добутків. І міркувати \<\<щоб вийняти множник з добутку, поділимо
цей добуток на цей множник\>\> тут не можна, бо в модульній арифметиці
це частоне так. Наприклад,
${26\bmod10}\dibbb{{=}}6\dibbb{{=}}{56\bmod10}$, тобто з точки зору
остач за модулем 10 чи́сла 26 та 56 однаковісінькі, але
${\tfrac{26}{2}\bmod10}\dibbb{{=}}{13\bmod10}\dibbb{{=}}3\dibbb{{\neq}}8\dibbb{{=}}{28\bmod10}\dibbb{{=}}{\tfrac{56}{2}\bmod10}$).

Спробуємо компенсувати дві п'ятірки з $(5{\times}10)$ двома двійками,
\<\<вийнятими\>\> з
${(1{\times}2{\times}3{\times}4}\dib{{\times}}{6{\times}7{\times}8{\times}9)}$,
дві п'ятірки з $(15{\times}20)$ двома двійками з
${(11{\times}12{\times}13{\times}14}\dib{{\times}}{16{\times}17{\times}18{\times}19)}$,
тощо.Дотого, що остання група може бути неповна, повернемося пізніше.
Тим,щовкожних таких 8-множникових дужках можна знайти більше, ніж дві,
двійки, знехтуємо: їхбільше, але \<\<вийматимемо\>\>дві.

Візьмемо число, що закінчується цифрою 2, та число, що закінчується
цифрою 4, й \<\<виймемо\>\> з кожного по одній двійці, поділивши кожне
окремо на 2 (ділимо самі́ чи́сла, не остачі). Можуть бути рівно два
випадки: або ці чи́сла являють собою $20k\,{+}\,2$ та $20k\,{+}\,4$, або
$20k\,{+}\,12$ та $20k\,{+}\,14$;у першому випадку після ділень виходить
$10k\,{+}\,1$ та$10k\,{+}\,2$,у дру́гому $10k\,{+}\,6$
та$10k\,{+}\,7$.Оскільки в межах цих 8-множникових дужок більше не треба
ділень, можна вертатися до модульної арифметики, відкидати $10k$ і
казати, що ${1{\times}2\,{=}\,2}$ та ${6{\times}7\,{=}\,42}$
закінчуються на однакову цифру 2. Лишається домножити це 2 на останні
цифри решти шести множників у дужках (1, 3,,,, 9), і отримати, що
остання цифра добутку (після \<\<виймання\>\> двох двійок) дорівнює ${(
2\,{\cdot}\,
1\,{\cdot}\,
3\,{\cdot}\,
6\,{\cdot}\,
7\,{\cdot}\,
8\,{\cdot}\,
9)\bmod10}
% % % \dibbb{{=}}
% % % {18144\bmod10}
\dib{{=}}4$. Остання цифра загального добутку всіх
${N\mathbin{\mathrm{div}}10}$ штук таких дужок рівна
${4^{N\mathbin{\mathrm{div}}10}\bmod10}$. Оскільки ${4^1\,{=}\,4}$,
\[1ex\]\[0pt\]${4^2\,{=}\,1\underline{\underline{6}}}$,
\[1ex\]\[0pt\]${4^3\,{=}\,6\underline{\underline{4}}}$,
\[1ex\]\[0pt\]${4^4\,{=}\,25\underline{\underline{6}}}$, ..., а
розглядаємо випадок ${N\,{\>}\,10}$, тобто
${(N\mathbin{\mathrm{div}}10)\,{\>}\,1}$, значення
${4^{N\mathbin{\mathrm{div}}10}\bmod10}$ можна знайти якось у стилі
`if((N`$\,\,$`div`$\,\,$`10)`$\,$`mod`$\,\,$`2)`$\,$`=`$\,$`1 then a:=4 else a:=6`.

Повернемось до врахування того, що при ${N\bmod10}\dib{{\neq}}0$ існує
ще остання дужка, яка рахується не за тими правилами, що решта дужок.
Якщо $1\dib{{\<}}{N\bmod10}\dib{{\<}}4$, то цій дужці не треба
компенсовувати ніяку п'ятірку, можна просто перемножити в модульній
арифметиці останні цифри; інакше кажучи, ${(N\bmod10)!\bmod10}$. Якщо ж
$5\dib{{\<}}{N\bmod10}\dib{{\<}}9$, то треба компенсувати рівно одну
п'ятірку. (Навіть якщо число останнього неповного десятку, що
закінчується на 5, кратне деякому $5^k$ при більшому $k$, то всі
п'ятірки, крім однієї, перейшли у ${(N\mathbin{\mathrm{div}}5)!}$.)
Поділимо на 2 число, що закінчується цифрою 2; можливі рівно два
випадки: або воно вигляду $20k\,{+}\,2$, або $20k\,{+}\,12$; у першому
отримуємо $10k\,{+}\,1$, у дру́гому $10k\,{+}\,6$; більше ділень
не треба, можна вертатися до модульної арифметики. Точно треба домножити
на 3 та 4 (борозглядаємо випадок $5\dib{{\<}}{N\bmod10}\dib{{\<}}9$);
отримуємо або
${(1{\times}3{\times}4)\bmod10}\dibbb{{=}}{12\bmod10}\dibbb{{=}}2$, або
${(6{\times}3{\times}4)\bmod10}\dibbb{{=}}{72\bmod10}\dibbb{{=}}2$,
тобто в обох випадках 2. Множити на 5 не треба й не можна, ця п'ятірка
вже врахована іншими засобами. Лишається тільки домножити в модульній
арифметиці на 6, 7, ...,${N\bmod10}$ (зокрема, при ${N\bmod10\,{=}\,5}$,
не домножувати ні на що).

Дії попереднього абзацу насправді рівносильні таким: \<\<порахувати
"в лоб" ${(N\bmod10)!}$; якщо кратний 10, поділити на 10; взяти останню
цифру\>\>. Це навіть простіше писати. Аленеясно, як строго доводити
правильність цього, не спираючись на попередній абзац.

Само собою, треба помножити (в модульній арифметиці) результат
(поза)минулого абзаца на раніше отриманий (рівний або 4, або 6)
результат ${4^{N\mathbin{\mathrm{div}}10}\bmod10}$, атакож домножити
(в модульній арифметиці) цей добуток на
${(N\mathbin{\mathrm{div}}5)!\bmod10}$, розв'язавши всю задачу заново з
аргументом ${N\mathbin{\mathrm{div}}5}$ замість $N$.
Це повторюватиметься приблизно $\log_{5}{N}$ разів. Що й задає
асимптотичну оцінку всього ро́зв'язку $\Theta(\log{N})$, бо все інше
виконується за $\Theta(1)$ (щось `if`-ом, щось циклом, але з дуже малою
кількістю ітерацій). Так що задачу в принципі можна було давати і для
значно більших $N$. Втім, вона і з обмеженням ${N\,{\<}\,2\,018\,019}$
виявилася дещо заскладною для переважної більшості учасників.
